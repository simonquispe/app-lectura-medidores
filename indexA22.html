<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Registro de Lectura de Medidores</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .registro { border: 1px solid #ccc; padding: 10px; margin: 10px 0; border-radius: 5px; }
    img { max-width: 200px; margin-top: 5px; }
    iframe { width: 100%; height: 250px; border: none; margin-top: 5px; }
  </style>
</head>
<body>
  <h1>Registro de Lectura de Medidores</h1>

  <!-- Formulario -->
  <form id="registroForm">
    <label>N° Medidor: 
      <input type="text" id="medidor" required>
    </label><br><br>

    <label>Lectura (kWh): 
      <input type="number" id="lectura" required>
    </label><br><br>

    <label>Foto del Medidor (cámara o archivo): 
      <input type="file" id="foto" accept="image/*" capture="environment" required>
    </label><br><br>

    <button type="button" onclick="guardarRegistro()">Guardar Registro</button>
  </form>

  <h2>Registros Guardados</h2>
  <div id="registros"></div>

  <script>
    function guardarRegistro() {
      const medidor = document.getElementById('medidor').value;
      const lectura = document.getElementById('lectura').value;
      const fotoInput = document.getElementById('foto');

      if (!medidor || !lectura || !fotoInput.files[0]) {
        alert("Completa todos los campos.");
        return;
      }

      const fecha = new Date().toLocaleString();

      // Obtener ubicación
      navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;

        // Convertir foto a URL
        const fotoURL = URL.createObjectURL(fotoInput.files[0]);

        // Mini-mapa usando OpenStreetMap (gratis, sin tarjeta)
        const mapaURL = `https://www.openstreetmap.org/export/embed.html?bbox=${lon-0.001},${lat-0.001},${lon+0.001},${lat+0.001}&layer=mapnik&marker=${lat},${lon}`;

        // Crear registro
        const registro = document.createElement('div');
        registro.className = "registro";
        registro.innerHTML = `
          <p><b>N° Medidor:</b> ${medidor}</p>
          <p><b>Lectura:</b> ${lectura} kWh</p>
          <p><b>Fecha:</b> ${fecha}</p>
          <p><b>Ubicación:</b> ${lat.toFixed(5)}, ${lon.toFixed(5)}<br>
             <a href="https://www.openstreetmap.org/?mlat=${lat}&mlon=${lon}#map=18/${lat}/${lon}" target="_blank">Ver en Mapa</a></p>
          <p><b>Foto:</b><br><img src="${fotoURL}" alt="Foto Medidor"></p>
          <p><b>Mapa:</b><br><iframe src="${mapaURL}"></iframe></p>
        `;

        document.getElementById('registros').appendChild(registro);

        // Reset form
        document.getElementById('registroForm').reset();
      }, err => {
        alert("No se pudo obtener la ubicación: " + err.message);
      });
    }
  </script>
</body>
</html>
