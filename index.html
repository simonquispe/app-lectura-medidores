<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Registro de Lectura de Medidores â€“ Sistema Completo ðŸš€</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <!-- SDK de Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f4f4f9; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 15px rgba(0,0,0,0.1 ); }
        h1, h2 { color: #333; text-align: center; }
        h2 { border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-top: 30px; }
        label { font-weight: bold; display: block; margin-top: 15px; }
        input[type="text"], input[type="file"], input[type="date"] { width: 100%; padding: 10px; margin: 5px 0 15px 0; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .button-container { display: flex; justify-content: center; gap: 10px; margin: 20px 0; flex-wrap: wrap; }
        button { padding: 10px 20px; font-size: 16px; border-radius: 5px; border: none; cursor: pointer; transition: background-color 0.3s, transform 0.1s; color: white; }
        button:active { transform: scale(0.98); }
        .guardar-btn { background-color: #28a745; }
        .guardar-btn:disabled { background-color: #94d3a2; cursor: not-allowed; }
        .filter-btn { background-color: #007bff; }
        .export-btn { background-color: #17a2b8; }
        .borrar-todos-btn { background-color: #dc3545; }
        #registros { margin-top: 20px; }
        .registro { display: flex; gap: 15px; margin-bottom: 15px; border: 1px solid #ddd; border-left: 5px solid #007bff; border-radius: 8px; padding: 15px; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .columna { flex: 1; display: flex; flex-direction: column; }
        .info { flex: 0.8; font-size: 14px; }
        .mapa, .foto-container { width: 100%; height: 100%; min-height: 300px; border: 1px solid #ccc; border-radius: 4px; }
        .borrar-btn { background-color: #ff4d4d; border: none; padding: 5px 10px; cursor: pointer; border-radius: 3px; align-self: center; }
        .titulo-col { font-weight: bold; text-align: center; margin-bottom: 5px; color: #555; }
        .foto-container { position: relative; overflow: hidden; background-color: #eee; }
        .foto-container img { width: 100%; height: 100%; object-fit: contain; position: absolute; top: 0; left: 0; cursor: grab; transition: transform 0.2s ease-out; touch-action: none; }
        .zoom-controls { position: absolute; top: 10px; right: 10px; z-index: 10; display: flex; flex-direction: column; }
        .zoom-btn { width: 30px; height: 30px; font-size: 20px; font-weight: bold; background-color: rgba(255, 255, 255, 0.8); border: 1px solid #ccc; cursor: pointer; margin-bottom: 2px; }
        @media (max-width: 768px) { .registro { flex-direction: column; } }
    </style>
</head>
<body>
<div class="container">
    <h1>Registro de Lectura de Medidores â€“ Sistema Completo ðŸš€</h1>
    
    <div id="form-container">
        <label for="medidor">NÂ° Medidor:</label>
        <input type="text" id="medidor">

        <label for="lectura">Lectura (kWh):</label>
        <input type="text" id="lectura">

        <label for="foto">Foto del Medidor:</label>
        <input type="file" id="foto" accept="image/*">

        <div class="button-container">
            <button onclick="guardarRegistro()" class="guardar-btn">Guardar en la Nube</button>
        </div>
    </div>

    <h2>Panel de Control</h2>
    <div class="button-container">
        <div>
            <label for="filter-date" style="text-align:center; margin-bottom: 5px;">Filtrar por Fecha</label>
            <input type="date" id="filter-date">
            <div style="display:flex; gap: 5px; margin-top: 5px;">
                <button onclick="filtrarRegistros()" class="filter-btn" style="flex:1;">Filtrar</button>
                <button onclick="mostrarRegistros()" class="filter-btn" style="flex:1;">Mostrar Todos</button>
            </div>
        </div>
        <button onclick="exportarKML()" class="export-btn">Exportar a KML</button>
        <button onclick="exportarCSV()" class="export-btn">Exportar a CSV (Excel)</button>
        <button onclick="borrarTodos()" class="borrar-todos-btn">Borrar Todos</button>
    </div>

    <h2>Registros Guardados</h2>
    <div id="registros"></div>
</div>

<script>
    // --- CONFIGURACIÃ“N ---
    const CLOUD_NAME = "dhjsqpvxf";
    const UPLOAD_PRESET = "iubbveg6";
    const firebaseConfig = {
        apiKey: "AIzaSyAMvE0ZJ0X9upRwp0Byz7Taoee_qX6rKbk",
        authDomain: "registros-medidores-ap.firebaseapp.com",
        projectId: "registros-medidores-ap",
        storageBucket: "registros-medidores-ap.appspot.com",
        messagingSenderId: "918106224992",
        appId: "1:918106224992:web:b5ba4244cdc6314e3e0505"
    };

    // --- INICIALIZACIÃ“N ---
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    let escalas = {};
    let registrosActuales = []; 
    document.addEventListener('DOMContentLoaded', () => mostrarRegistros());

    // --- LÃ“GICA PRINCIPAL ---
    async function mostrarRegistros(querySnapshot) {
        const registrosDiv = document.getElementById("registros");
        registrosDiv.innerHTML = "Cargando registros...";
        try {
            const snapshot = querySnapshot || await db.collection("registros").orderBy("timestamp", "desc").get();
            registrosActuales = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            if (registrosActuales.length === 0) {
                registrosDiv.innerHTML = "<p style='text-align:center;'>No se encontraron registros para la selecciÃ³n actual.</p>";
                return;
            }
            registrosDiv.innerHTML = "";
            registrosActuales.forEach(reg => {
                const registroDiv = document.createElement("div");
                registroDiv.className = "registro";
                registroDiv.setAttribute('data-id', reg.id);
                registroDiv.innerHTML = `
                    <div class="info columna"><p><b>NÂ° Medidor:</b> ${reg.nro}</p><p><b>Lectura:</b> ${reg.lectura} kWh</p><p><b>Fecha:</b> ${new Date(reg.timestamp).toLocaleString('es-BO')}</p><p><b>UbicaciÃ³n:</b> ${reg.lat.toFixed(5)}, ${reg.lon.toFixed(5)}</p><a href="https://www.google.com/maps?q=${reg.lat},${reg.lon}" target="_blank">Ver en Google Maps</a></div>
                    <div class="columna"><div class="titulo-col">Foto</div><div class="foto-container" id="container-${reg.id}"><img id="img-${reg.id}" src="${reg.foto}"><div class="zoom-controls"><button class="zoom-btn" onclick="zoomImagen('img-${reg.id}', 1.2 )">+</button><button class="zoom-btn" onclick="zoomImagen('img-${reg.id}', 0.8)">-</button></div></div></div>
                    <div class="columna"><div class="titulo-col">Mapa</div><div class="mapa" id="map${reg.id}"></div></div>
                    <div class="columna" style="flex:0.3; justify-content:center;"><button class="borrar-btn" onclick="borrarRegistro('${reg.id}')">Borrar</button></div>`;
                registrosDiv.appendChild(registroDiv);
                const map = L.map(`map${reg.id}`).setView([reg.lat, reg.lon], 16);
                L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 } ).addTo(map);
                L.marker([reg.lat, reg.lon]).addTo(map).bindPopup(`Medidor: ${reg.nro}`).openPopup();
                activarArrastre(`container-${reg.id}`);
            });
        } catch (error) {
            console.error("Error al cargar registros: ", error);
            registrosDiv.innerHTML = "<p style='text-align:center; color:red;'>Error al cargar los registros.</p>";
        }
    }

    // --- FUNCIÃ“N RE-RE-CORREGIDA (EDICIÃ“N BOLIVIA) ---
    async function filtrarRegistros() {
        const fechaInput = document.getElementById("filter-date").value;
        if (!fechaInput) {
            alert("Por favor, selecciona una fecha.");
            return;
        }
        
        // El input de fecha da una cadena como "2025-08-28".
        // Lo convertimos a una fecha asumiendo que es el inicio del dÃ­a en la zona horaria del usuario.
        const inicioDelDia = new Date(fechaInput + "T00:00:00");
        
        // Creamos el final del dÃ­a sumando 24 horas y restando 1 milisegundo.
        const finDelDia = new Date(inicioDelDia.getTime() + (24 * 60 * 60 * 1000) - 1);

        const query = db.collection("registros")
            .where("timestamp", ">=", inicioDelDia.getTime())
            .where("timestamp", "<=", finDelDia.getTime())
            .orderBy("timestamp", "desc");
        
        const snapshot = await query.get();
        mostrarRegistros(snapshot);
    }

    async function guardarRegistro() {
        const nro = document.getElementById("medidor").value.trim();
        const lectura = document.getElementById("lectura").value.trim();
        const fotoFile = document.getElementById("foto").files[0];
        if (!nro || !lectura || !fotoFile) { alert("Por favor, completa todos los campos."); return; }
        const botonGuardar = document.querySelector('.guardar-btn');
        botonGuardar.textContent = "Procesando..."; botonGuardar.disabled = true;
        try {
            const fotoURL = await subirImagenACloudinary(fotoFile);
            const pos = await new Promise((resolve, reject) => navigator.geolocation.getCurrentPosition(resolve, reject, { enableHighAccuracy: true }));
            const registro = { nro, lectura, foto: fotoURL, lat: pos.coords.latitude, lon: pos.coords.longitude, timestamp: Date.now() };
            await db.collection("registros").add(registro);
            alert("Â¡Registro guardado en la nube con Ã©xito!");
            document.getElementById("medidor").value = ""; document.getElementById("lectura").value = ""; document.getElementById("foto").value = "";
            mostrarRegistros();
        } catch (error) {
            console.error("Error en el proceso de guardado: ", error); alert("Error: " + error.message);
        } finally {
            botonGuardar.textContent = "Guardar en la Nube"; botonGuardar.disabled = false;
        }
    }

    async function borrarRegistro(id) {
        if (!confirm("Â¿Seguro que quieres borrar este registro de la nube?")) return;
        try { await db.collection("registros").doc(id).delete(); alert("Registro eliminado."); document.getElementById("filter-date").value = ""; mostrarRegistros(); }
        catch (error) { console.error("Error al borrar: ", error); alert("No se pudo eliminar el registro."); }
    }

    async function borrarTodos() {
        if (!confirm("Â¡CUIDADO! Â¿Borrar TODOS los registros de la base de datos? Esta acciÃ³n es IRREVERSIBLE.")) return;
        try {
            const snapshot = await db.collection("registros").get();
            if (snapshot.empty) { alert("No hay registros para borrar."); return; }
            const batch = db.batch();
            snapshot.docs.forEach(doc => batch.delete(doc.ref));
            await batch.commit();
            alert("Todos los registros han sido eliminados de la nube."); mostrarRegistros();
        } catch (error) { console.error("Error borrando todo: ", error); alert("OcurriÃ³ un error al intentar borrar todo."); }
    }

    // --- FUNCIONES DE EXPORTACIÃ“N ---
    function exportarKML() {
        if (registrosActuales.length === 0) { alert("No hay registros en la vista actual para exportar."); return; }
        alert("Generando archivo KML de los registros visibles...");
        let kmlContent = `<?xml version="1.0" encoding="UTF-8"?><kml xmlns="http://www.opengis.net/kml/2.2"><Document><name>Registros de Medidores</name>`;
        registrosActuales.forEach(reg => {
            kmlContent += `<Placemark><name>${reg.nro}</name><description><![CDATA[<b>Lectura:</b> ${reg.lectura} kWh  
<b>Fecha:</b> ${new Date(reg.timestamp ).toLocaleString('es-BO')}  
<img src="${reg.foto}" alt="Foto" width="200">]]></description><Point><coordinates>${reg.lon},${reg.lat},0</coordinates></Point></Placemark>`;
        });
        kmlContent += `</Document></kml>`;
        descargarArchivo(kmlContent, 'registros.kml', 'application/vnd.google-earth.kml+xml');
    }

    function exportarCSV() {
        if (registrosActuales.length === 0) { alert("No hay registros en la vista actual para exportar."); return; }
        alert("Generando archivo CSV de los registros visibles...");
        let csvContent = "Nro Medidor,Lectura (kWh),Fecha,Latitud,Longitud,URL Foto\n";
        registrosActuales.forEach(reg => {
            const fecha = new Date(reg.timestamp).toLocaleString('es-BO').replace(/,/g, '');
            csvContent += `"${reg.nro}","${reg.lectura}","${fecha}",${reg.lat},${reg.lon},"${reg.foto}"\n`;
        });
        descargarArchivo(csvContent, 'registros.csv', 'text/csv;charset=utf-8;');
    }

    function descargarArchivo(contenido, nombreArchivo, tipoMIME) {
        const blob = new Blob([contenido], { type: tipoMIME });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = nombreArchivo;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // --- FUNCIONES AUXILIARES ---
    async function subirImagenACloudinary(file) { const url = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`; const formData = new FormData( ); formData.append('file', file); formData.append('upload_preset', UPLOAD_PRESET); const response = await fetch(url, { method: 'POST', body: formData }); if (!response.ok) throw new Error('No se pudo subir la imagen.'); const data = await response.json(); return data.secure_url; }
    function zoomImagen(imgId, factor) { const img = document.getElementById(imgId); if (!escalas[imgId]) escalas[imgId] = 1; escalas[imgId] *= factor; if (escalas[imgId] < 1) escalas[imgId] = 1; if (escalas[imgId] > 10) escalas[imgId] = 10; img.style.transform = `scale(${escalas[imgId]})`; if (escalas[imgId] === 1) { img.style.left = '0px'; img.style.top = '0px'; } }
    function activarArrastre(containerId) { const container = document.getElementById(containerId); const img = container.querySelector('img'); let isDown = false, startX, startY, scrollLeft, scrollTop; const start = (e) => { if (escalas[img.id] <= 1) return; isDown = true; img.style.cursor = 'grabbing'; const pageX = e.pageX || e.touches[0].pageX; const pageY = e.pageY || e.touches[0].pageY; startX = pageX - container.offsetLeft; startY = pageY - container.offsetTop; scrollLeft = img.offsetLeft; scrollTop = img.offsetTop; }; const end = () => { isDown = false; img.style.cursor = 'grab'; }; const move = (e) => { if (!isDown) return; e.preventDefault(); const pageX = e.pageX || e.touches[0].pageX; const pageY = e.pageY || e.touches[0].pageY; const x = pageX - container.offsetLeft; const y = pageY - container.offsetTop; const walkX = (x - startX); const walkY = (y - startY); img.style.left = (scrollLeft + walkX) + 'px'; img.style.top = (scrollTop + walkY) + 'px'; }; container.addEventListener('mousedown', start); container.addEventListener('mouseleave', end); container.addEventListener('mouseup', end); container.addEventListener('mousemove', move); container.addEventListener('touchstart', start); container.addEventListener('touchend', end); container.addEventListener('touchmove', move); }
</script>
</body>
</html>

